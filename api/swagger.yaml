openapi: 3.0.3
info:
  title: Algorithmic Communication Models on the C. elegans Connectome API
  version: 0.1.0
  description: >
    Services to ingest datasets, build graph variants (V1/V2/V3), run experiments
    (E1–E5: BFS, Dijkstra α-sweep, decentralized navigation, diffusion/communicability,
    max-flow/min-cut + ablations), generate null models (degree-preserving), and fetch
    run status, artifacts, and configuration.

servers:
  - url: http://localhost:8000
    description: Local development

tags:
  - name: system
    description: Health and version
  - name: datasets
    description: Dataset upload/registration
  - name: pipeline
    description: Preprocessing to build V1/V2/V3 graph variants
  - name: experiments
    description: E1–E5 experiments
  - name: nulls
    description: Null-model generation and z-scoring
  - name: runs
    description: Run status and artifact retrieval
  - name: configs
    description: Get/update project configuration (params.yaml)

paths:

  /health:
    get:
      tags: [system]
      summary: Health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }

  /version:
    get:
      tags: [system]
      summary: Version info
      responses:
        '200':
          description: Version details
          content:
            application/json:
              schema:
                type: object
                properties:
                  api: { type: string, example: 0.1.0 }
                  commit: { type: string, example: a1b2c3d }
                  networkx: { type: string, example: 3.5.1 }

  /datasets:
    post:
      tags: [datasets]
      summary: Upload or register a dataset
      description: Accepts .gml / .csv / .zip (containing .mtx), or a registered path.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Original data file (.gml / .csv / .zip)
                note:
                  type: string
              required: [file]
      responses:
        '201':
          description: Dataset created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dataset'
        '400':
          $ref: '#/components/responses/BadRequest'

  /datasets/{datasetId}:
    get:
      tags: [datasets]
      summary: Get dataset metadata
      parameters:
        - in: path
          name: datasetId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Dataset metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dataset'
        '404':
          $ref: '#/components/responses/NotFound'

  /preprocess:
    post:
      tags: [pipeline]
      summary: Preprocess a dataset and build V1/V2/V3 graphs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                datasetId: { type: string }
                buildV1: { type: boolean, default: true }
                buildV2: { type: boolean, default: true }
                buildV3: { type: boolean, default: true }
                dropSelfLoops: { type: boolean, default: true }
              required: [datasetId]
      responses:
        '202':
          description: Preprocessing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'
        '400':
          $ref: '#/components/responses/BadRequest'

  /experiments/e1-bfs:
    post:
      tags: [experiments]
      summary: E1 — BFS cascades (coverage / first-passage)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BFSRequest'
      responses:
        '202':
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  /experiments/e2-dijkstra:
    post:
      tags: [experiments]
      summary: E2 — Dijkstra α-sweep (geometry × topology cost)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DijkstraRequest'
      responses:
        '202':
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  /experiments/e3-navigation:
    post:
      tags: [experiments]
      summary: E3 — Decentralized navigation (success rate / stretch)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NavigationRequest'
      responses:
        '202':
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  /experiments/e4-diffusion:
    post:
      tags: [experiments]
      summary: E4 — Diffusion/communicability baseline and correlations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiffusionRequest'
      responses:
        '202':
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  /experiments/e5-flow:
    post:
      tags: [experiments]
      summary: E5 — Max-flow / Min-cut and targeted ablations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FlowRequest'
      responses:
        '202':
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  /null-models:
    post:
      tags: [nulls]
      summary: Generate degree-preserving null graphs and compute z-scores
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                graphVariant:
                  type: string
                  enum: [V1, V2, V3]
                  default: V2
                nGraphs:
                  type: integer
                  default: 100
                metrics:
                  type: array
                  items: { type: string, example: success_rate }
      responses:
        '202':
          description: Run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  /runs/{runId}:
    get:
      tags: [runs]
      summary: Get run status and outputs
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'
        '404':
          $ref: '#/components/responses/NotFound'

  /artifacts/{artifactId}:
    get:
      tags: [runs]
      summary: Download an artifact (CSV/PNG/JSON/etc.)
      parameters:
        - in: path
          name: artifactId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Binary stream
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

  /configs:
    get:
      tags: [configs]
      summary: Get current configuration (params.yaml equivalent)
      responses:
        '200':
          description: Current params
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Params'
    put:
      tags: [configs]
      summary: Update configuration (partial)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Params'
      responses:
        '200':
          description: Updated params
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Params'

components:

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  schemas:

    Dataset:
      type: object
      properties:
        id: { type: string, example: ds_01HABCDEF }
        filename: { type: string, example: celegansneural.gml }
        sizeBytes: { type: integer, example: 2456789 }
        createdAt: { type: string, format: date-time }
        status: { type: string, example: ready }

    RunStatus:
      type: string
      enum: [queued, running, succeeded, failed]

    Artifact:
      type: object
      properties:
        id: { type: string, example: art_01HABCDE }
        name: { type: string, example: e2_dijkstra_alpha_summary.csv }
        mediaType: { type: string, example: text/csv }
        sizeBytes: { type: integer }
        downloadUrl: { type: string }

    Run:
      type: object
      properties:
        id: { type: string, example: run_01HABCDE }
        type: { type: string, example: e2-dijkstra }
        status: { $ref: '#/components/schemas/RunStatus' }
        createdAt: { type: string, format: date-time }
        startedAt: { type: string, format: date-time, nullable: true }
        finishedAt: { type: string, format: date-time, nullable: true }
        params: { type: object }
        artifacts:
          type: array
          items: { $ref: '#/components/schemas/Artifact' }
        error: { $ref: '#/components/schemas/Error', nullable: true }

    BFSRequest:
      type: object
      properties:
        graphVariant: { type: string, enum: [V1, V2, V3], default: V1 }
        sensorySeeds:
          type: array
          items: { type: string }
          description: Seed neuron IDs; if empty, select top-k automatically
        maxLayers:
          type: integer
          description: BFS depth cap; defaults to |V|
      required: [graphVariant]

    DijkstraRequest:
      type: object
      properties:
        graphVariant: { type: string, enum: [V1, V2], default: V2 }
        alphaGrid:
          type: array
          items: { type: number, format: float }
          example: [0.0, 0.25, 0.5, 0.75, 1.0]
        topologicalCost:
          type: string
          enum: [inverse_weight, unit]
          default: inverse_weight
        useGeometry:
          type: boolean
          description: Enable geometric term if node coordinates exist
          default: false
      required: [graphVariant, topologicalCost]

    NavigationRequest:
      type: object
      properties:
        graphVariant: { type: string, enum: [V1, V2, V3], default: V2 }
        maxStepsFactor: { type: number, default: 1.0 }
        allowBacktrack: { type: boolean, default: true }
        localScoringWeights:
          type: object
          properties:
            degree: { type: number, default: 0.2 }
            weight: { type: number, default: 0.4 }
            homophily: { type: number, default: 0.2 }
            dist_to_target: { type: number, default: 0.2 }
        sensorySeeds:
          type: array
          items: { type: string }
        motorTargets:
          type: array
          items: { type: string }

    DiffusionRequest:
      type: object
      properties:
        graphVariant: { type: string, enum: [V1, V2], default: V2 }
        model: { type: string, enum: [heat_kernel, k_step_rw], default: heat_kernel }
        tau: { type: number, default: 0.5 }
        k: { type: integer, default: 3 }

    FlowRequest:
      type: object
      properties:
        graphVariant: { type: string, enum: [V2], default: V2 }
        sensorySet:
          type: array
          items: { type: string }
          description: Source set; if empty, select top-k by in-degree
        motorSet:
          type: array
          items: { type: string }
          description: Sink set; if empty, select top-k by out-degree
        ablationTopK: { type: integer, default: 10 }
        capacityKey: { type: string, default: weight }

    Params:
      type: object
      description: Project configuration aligned with params.yaml
      properties:
        project:
          type: object
          properties:
            name: { type: string }
            seed: { type: integer }
        data:
          type: object
          properties:
            raw_dir: { type: string }
            interim_dir: { type: string }
            processed_dir: { type: string }
            graphs:
              type: object
              properties:
                V1: { type: string }
                V2: { type: string }
                V3: { type: string }
            sensory_list: { type: string, nullable: true }
            motor_list: { type: string, nullable: true }
        analysis:
          type: object
          properties:
            alpha_grid:
              type: array
              items: { type: number }
            dijkstra:
              type: object
              properties:
                topological_cost: { type: string }
                distance_key: { type: string, nullable: true }
            navigation:
              type: object
              properties:
                max_steps_factor: { type: number }
                allow_backtrack: { type: boolean }
                local_scoring_weights:
                  type: object
                  additionalProperties: { type: number }
            diffusion:
              type: object
              properties:
                model: { type: string }
                tau: { type: number }
                k: { type: integer }
            flow:
              type: object
              properties:
                capacity_key: { type: string }
                unit_capacity_on_V1: { type: boolean }
                symmetrize_for_V3: { type: boolean }
            null_model:
              type: object
              properties:
                type: { type: string }
                n_graphs: { type: integer }
                preserve_in_out: { type: boolean }
        report:
          type: object
          properties:
            figures_dir: { type: string }
            tables_dir: { type: string }
            bootstrap_iter: { type: integer }
            stats:
              type: object
              properties:
                correlation: { type: string }
                paired_test: { type: string }
                fdr: { type: number }

    Error:
      type: object
      properties:
        code: { type: string, example: BAD_REQUEST }
        message: { type: string, example: invalid alpha grid }
